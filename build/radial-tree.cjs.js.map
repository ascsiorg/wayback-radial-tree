{"version":3,"file":"radial-tree.cjs.js","sources":["../src/js/processing/surt.js","../src/js/processing/hierarchy.js","../src/js/processing/timemap.js","../src/js/rendering/container.js","../src/js/rendering/tree.js","../src/js/rendering/year-button.js","../src/js/rendering/year-button-container.js","../src/js/index.js"],"sourcesContent":["/**\n * get SURT (Sort-friendly URI Reordering Transform)\n * https://github.com/internetarchive/surt\n * and convert it back to URL\n *\n * [!] current implementation works only with host part of SURT\n *\n * @param surt\n * @returns {String}\n */\nexport function surtToUrl(surt) {\n  if (!surt) {\n    return surt;\n  }\n  //drop last ')'\n  surt = surt.slice(0, surt.length - 1);\n  return surt.split(',').reverse().join('.');\n}\n","import {surtToUrl} from './surt';\n\n\n/**\n * @private\n *\n * traverse in depth from parent by path\n *\n * @param parent is current node\n * @param path is array of names\n * @returns {*}\n */\nfunction buildHierarchInDepth(parent, path) {\n  if (!path || path.length === 0) {\n    return;\n  }\n\n  const [name, ...rest] = path;\n\n  if (!name) {\n    return;\n  }\n\n  let nextParent;\n\n  if (parent.children) {\n    nextParent = parent.children.filter(c => c.name === name)[0];\n  } else {\n    parent.children = [];\n  }\n\n  if (!nextParent) {\n    nextParent = {\n      name,\n    };\n\n    parent.children.push(nextParent);\n  }\n\n  buildHierarchInDepth(nextParent, rest);\n}\n\n/**\n * build hierarchical structure:\n *\n * {name: '{name}': children: [...]}\n *\n * which is valid for d3.hierarchy\n * from timemap site data\n *\n * @param fields -\n * @param data - source\n * @param targetField - which field we use to create hierarchy\n *\n * @returns {Object}\n */\nexport function buildHierarchy(fields, data, {targetField}) {\n  return data.reduce((res, row) => {\n    const value = fields.getValueByName(row, targetField);\n    const [host, ...path] = value.split('/');\n    res.name = surtToUrl(host);\n    buildHierarchInDepth(res, path);\n    return res;\n  }, {});\n}\n","import _ from 'lodash';\n\n/**\n * extract fields from time map data\n *\n */\nexport class Fields {\n  constructor(data) {\n    this.fields = data[0];\n    this.getIndexByName = _.memoize(this.getIndexByName);\n  }\n\n  /**\n   * get index of field by name\n   *\n   * @param name\n   */\n  getIndexByName(name) {\n    return this.fields.indexOf(name);\n  }\n\n  /**\n   * get value of field in row by name\n   *\n   * @param row\n   * @param name\n   * @returns {*}\n   */\n  getValueByName(row, name) {\n    return row[this.getIndexByName(name)];\n  }\n}\n\n/**\n * get all sorted years from grouped time map data\n *\n * @param data time map data\n * @returns {Array} years\n */\nexport function extractYearsFromGroupedTimeMap(data) {\n  if (!data) {\n    return data;\n  }\n\n  return Object.keys(data)\n    .sort();\n}\n\n\n/**\n * data processing pipeline for time map:\n *\n * [[<keys>], [values]....[values]]\n *\n * - group by one field\n * - dedup by another field\n * - order by one field\n *\n * @param data timemap format\n * @param groupBy\n * @param dedupBy\n * @param orderBy\n *\n * @return processed data\n */\nexport function processTimeMap(data, {groupBy, dedupBy, orderBy} = {}) {\n  if (!data) {\n    return data;\n  }\n\n  const fields = new Fields(data);\n\n  const res = data\n    .slice(1)\n    .reduce((result, row) => {\n      const oneGroup = result[fields.getValueByName(row, groupBy)] || {};\n\n      // don't add if we already have it\n      if (!oneGroup[fields.getValueByName(row, dedupBy)]) {\n        oneGroup[fields.getValueByName(row, dedupBy)] = row;\n      }\n\n      result[fields.getValueByName(row, groupBy)] = oneGroup;\n      return result;\n    }, {});\n    \n  // if someday we would get bad performance here\n  // we could make insertion with sorthing above\n  return _(res)\n    .mapValues(value => Object.values(value))\n    .mapValues(value => _.sortBy(value, fields.getIndexByName(orderBy)))\n    .value();\n}\n","export function renderContainer() {\n  let content = document.createElement('div');\n  content.setAttribute('class', 'rt-content');\n  let divBtn = document.createElement('div');\n  divBtn.setAttribute('class', 'div-btn');\n\n  let sequence = document.createElement('p');\n  sequence.setAttribute('class', 'sequence');\n  let chart = document.createElement('div');\n  chart.setAttribute('id', 'chart');\n  content.appendChild(divBtn);\n  content.appendChild(sequence);\n  content.appendChild(chart);\n  content.style.display = 'block';\n  return content;\n}\n","import * as d3 from 'd3';\n\nconst arc = d3.arc()\n  .startAngle(d => d.x0)\n  .endAngle(d => d.x1)\n  .innerRadius(d => Math.sqrt(d.y0))\n  .outerRadius(d => Math.sqrt(d.y1));\n\nconst colors = d3.scaleOrdinal(d3.schemePaired);\n\n/**\n * Render d3.hierarchy from passed hierarchical data\n *\n * @param element\n * @param vis\n * @param radius\n * @param baseURL\n * @param currentYear\n * @param data\n */\nexport function createVisualization(element, vis, radius, baseURL, currentYear, data) {\n  let partition = d3.partition()\n    .size([2 * Math.PI, radius * radius]);\n\n  //append 'root' we will exclude it on rendering\n  let root = d3.hierarchy({children: [data]})\n    .sum(d => !d.children)\n    .sort((a, b) => b.value - a.value);\n\n  let nodes = partition(root)\n    .descendants();\n\n  vis.selectAll('path')\n    .data(nodes)\n    .enter()\n    .append('a')\n    .attr('xlink:href', currentUrl)\n    .on('touchstart', touchStart)\n    .append('svg:path')\n    .attr('display', d => d.depth ? null : 'none')\n    .attr('d', arc)\n    .attr('fill-rule', 'evenodd')\n    .style('fill', d => colors((d.children ? d : d.parent).data.name))\n    .style('opacity', 1)\n    .style('cursor', 'pointer')\n    .on('mouseover', mouseover);\n\n  d3.select('#d3_container')\n    .on('mouseleave', mouseleave);\n\n  /** on mobile devices, touching the RadialTree prevents the ``click``\n   *  event and shows the URL like on ``mouseover`` event. Users can click\n   *  on the URL to visit the target page */\n  function touchStart(d) {\n    d3.event.preventDefault();\n    d3.event.stopPropagation();\n    mouseover(d);\n    return false;\n  }\n\n  function currentUrl(d) {\n    const anc = d.ancestors().reverse();\n    let url = '';\n    for (let i = 1; i < anc.length; i++) {\n      if (anc[i].data.name === 'end') {\n        break;\n      }\n      url = url + '/' + anc[i].data.name;\n    }\n    return `${baseURL}/web/${currentYear}0630${url}`;\n  }\n\n  function mouseover(d) {\n    let sequenceArray = d.ancestors().reverse();\n    sequenceArray.shift();\n    let url = currentUrl(d);\n    updateBreadcrumbs(sequenceArray, url);\n    d3.selectAll('path').style('opacity', 0.3);\n\n    vis\n      .selectAll('path')\n      .filter(node => sequenceArray.indexOf(node) >= 0)\n      .style('opacity', 1);\n  }\n\n  function mouseleave() {\n    element.querySelector('.sequence').innerHTML = '';\n\n    d3.selectAll('path')\n      .on('mouseover', null);\n\n    d3.selectAll('path')\n      .transition()\n      .style('opacity', 1)\n      .on('end', function () {\n        d3.select(this).on('mouseover', mouseover);\n      });\n  }\n\n  function updateBreadcrumbs(nodeArray, url) {\n    let text = '';\n    let symb = document.createElement('span');\n    symb.setAttribute('class', 'symb');\n    symb.innerHTML = '/';\n    for (let i = 0; i < nodeArray.length; i++) {\n      if (i === 0) {\n        text = ' ' + nodeArray[i].data.name;\n      } else {\n        text = text + symb.innerHTML + nodeArray[i].data.name;\n      }\n    }\n    text = decodeURIComponent(text);\n    element.querySelector('.sequence').innerHTML = `<a href=\"${url}\">${text}</a>`;\n  }\n}\n","export function renderYearButton(year) {\n  let btn = document.createElement('button');\n  btn.setAttribute('class', 'year-btn');\n  btn.setAttribute('id', year);\n  btn.innerHTML = year;\n  return btn;\n}\n\nexport function getYearByBtn(btn) {\n  return btn.id;\n}\n\nexport function getButtonByYear(container, year) {\n  return container.ownerDocument.getElementById(year);\n}\n","import {renderYearButton, getYearByBtn} from './year-button';\n\nexport function renderYearButtons(element, allYears, onYearSelect) {\n  let divBtn = element.querySelector('.div-btn');\n  divBtn.onclick = (evt) => onYearSelect(getYearByBtn(evt.target));\n\n  if (!element.querySelector('.year-btn')) {\n    allYears.forEach(year =>\n      divBtn.appendChild(renderYearButton(year))\n    );\n  }\n}\n","import * as d3 from 'd3';\nimport {buildHierarchy, extractYearsFromGroupedTimeMap, Fields, processTimeMap} from './processing';\nimport {createVisualization, getButtonByYear, renderContainer, renderYearButtons} from './rendering';\n\n/**\n *\n * Radial Tree Library\n *\n * @param {DOMElement} element\n * @param {Array} cdx_data: decoded CDX Query data retrieved by:\n ``/web/timemap/json?url=example.com/&fl=timestamp:4,urlkey&matchType=prefix\n &filter=statuscode:200&filter=mimetype:text/html&collapse=urlkey\n &collapse=timestamp:4&limit=100000``.\n * @param {Object} [options]\n * Option baseURL defines the target Wayback Machine server.\n *\n */\nexport function RadialTree(element, cdx_data, options = {}) {\n  let baseURL = options.baseURL || 'https://web.archive.org';\n\n  // render\n\n  const container = renderContainer();\n  element.appendChild(container);\n\n  const fields = new Fields(cdx_data);\n  const urlsByYear = processTimeMap(cdx_data, {\n    groupBy: 'timestamp:4',\n    dedupBy: 'urlkey',\n    orderBy: 'urlkey',\n  });\n  const years = extractYearsFromGroupedTimeMap(urlsByYear);\n\n  renderYearButtons(element, years, selectYear);\n\n  // highlight the 2nd last year if available, else hightlight the last.\n  // necessary because the last year may not have much data.\n  // const lastButOneYear = allYears[allYears.length - 2] || allYears[0];\n  const selectedBtn = years[years.length - 2] || years[0];\n  selectYear(selectedBtn);\n\n  function selectYear(year) {\n    // hide active button\n    if (element.querySelector('.active-btn')) {\n      element.querySelector('.active-btn').classList.remove('active-btn');\n    }\n\n    // show active button\n    const btn = getButtonByYear(element, year);\n    if (btn) {\n      btn.classList.add('active-btn');\n    }\n\n    renderChart(element, year);\n  }\n\n  function renderChart(element, currentYear) {\n    element.querySelector('.sequence').innerHTML = '';\n    element.querySelector('#chart').innerHTML = '';\n\n    const width = element.querySelector('#chart').offsetWidth;\n    const height = width;\n    const radius = Math.min(width, height) / 2;\n\n    let vis = d3.select('#chart')\n      .append('svg:svg')\n      .attr('width', width)\n      .attr('height', height)\n      .append('svg:g')\n      .attr('id', 'd3_container')\n      .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');\n\n    vis.append('svg:circle')\n      .attr('r', radius)\n      .style('opacity', 0);\n\n    const urls = urlsByYear[currentYear];\n    const hierarchy = buildHierarchy(fields, urls, {\n      targetField: 'urlkey',\n    });\n\n    createVisualization(element, vis, radius, baseURL, currentYear, hierarchy);\n  }\n}\n"],"names":["surtToUrl","surt","slice","length","split","reverse","join","buildHierarchInDepth","parent","path","name","rest","nextParent","children","filter","c","push","buildHierarchy","fields","data","targetField","reduce","res","row","value","getValueByName","host","Fields","getIndexByName","_","memoize","indexOf","extractYearsFromGroupedTimeMap","Object","keys","sort","processTimeMap","groupBy","dedupBy","orderBy","result","oneGroup","mapValues","values","sortBy","renderContainer","content","document","createElement","setAttribute","divBtn","sequence","chart","appendChild","style","display","arc","d3","startAngle","d","x0","endAngle","x1","innerRadius","Math","sqrt","y0","outerRadius","y1","colors","scaleOrdinal","schemePaired","createVisualization","element","vis","radius","baseURL","currentYear","partition","size","PI","root","hierarchy","sum","a","b","nodes","descendants","selectAll","enter","append","attr","currentUrl","on","touchStart","depth","mouseover","select","mouseleave","event","preventDefault","stopPropagation","anc","ancestors","url","i","sequenceArray","shift","updateBreadcrumbs","node","querySelector","innerHTML","transition","nodeArray","text","symb","decodeURIComponent","renderYearButton","year","btn","getYearByBtn","id","getButtonByYear","container","ownerDocument","getElementById","renderYearButtons","allYears","onYearSelect","onclick","evt","target","forEach","RadialTree","cdx_data","options","urlsByYear","years","selectYear","selectedBtn","classList","remove","add","renderChart","width","offsetWidth","height","min","urls"],"mappings":"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"}