{"version":3,"file":"radial-tree.umd.js","sources":["../src/js/processing/hierarchy.js","../src/js/processing/surt.js","../src/js/processing/timemap.js","../src/js/rendering/container.js","../src/js/rendering/tree.js","../src/js/rendering/year-button.js","../src/js/rendering/year-button-container.js","../src/js/index.js"],"sourcesContent":["import {surtToUrl} from './surt';\n\n\n/**\n * @private\n *\n * traverse in depth from parent by path\n *\n * @param parent is current node\n * @param path is array of names\n * @returns {*}\n */\nfunction buildHierarchInDepth(parent, path) {\n  if (!path || path.length === 0) {\n    return;\n  }\n\n  const [name, ...rest] = path;\n\n  if (!name) {\n    return;\n  }\n\n  let nextParent;\n\n  if (parent.children) {\n    nextParent = parent.children.filter(c => c.name === name)[0];\n  } else {\n    parent.children = [];\n  }\n\n  if (!nextParent) {\n    nextParent = {\n      name,\n    };\n\n    parent.children.push(nextParent);\n  }\n\n  buildHierarchInDepth(nextParent, rest);\n}\n\n/**\n * build hierarchical structure:\n *\n * {name: '{name}': children: [...]}\n *\n * which is valid for d3.hierarchy\n * from timemap site data\n *\n * @param fields -\n * @param data - source\n * @param targetField - which field we use to create hierarchy\n *\n * @returns {Object}\n */\nexport function buildHierarchy(fields, data, {targetField}) {\n  return data.reduce((res, row) => {\n    const value = fields.getValueByName(row, targetField);\n    const [host, ...path] = value.split('/');\n    res.name = surtToUrl(host);\n    buildHierarchInDepth(res, path);\n    return res;\n  }, {});\n}\n","/**\n * get SURT (Sort-friendly URI Reordering Transform)\n * https://github.com/internetarchive/surt\n * and convert it back to URL\n *\n * [!] current implementation works only with host part of SURT\n *\n * @param surt\n * @returns {String}\n */\nexport function surtToUrl(surt) {\n  if (!surt) {\n    return surt;\n  }\n  //drop last ')'\n  surt = surt.slice(0, surt.length - 1);\n  return surt.split(',').reverse().join('.');\n}\n","import _ from 'lodash';\n\n/**\n * extract fields from time map data\n *\n */\nexport class Fields {\n  constructor(data) {\n    this.fields = data[0];\n    this.getIndexByName = _.memoize(this.getIndexByName);\n  }\n\n  /**\n   * get index of field by name\n   *\n   * @param name\n   */\n  getIndexByName(name) {\n    return this.fields.indexOf(name);\n  }\n\n  /**\n   * get value of field in row by name\n   *\n   * @param row\n   * @param name\n   * @returns {*}\n   */\n  getValueByName(row, name) {\n    return row[this.getIndexByName(name)];\n  }\n}\n\n/**\n * get all sorted years from grouped time map data\n *\n * @param data time map data\n * @returns {Array} years\n */\nexport function extractYearsFromGroupedTimeMap(data) {\n  if (!data) {\n    return data;\n  }\n\n  return Object.keys(data)\n    .sort();\n}\n\n\n/**\n * data processing pipeline for time map:\n *\n * [[<keys>], [values]....[values]]\n *\n * - group by one field\n * - dedup by another field\n * - order by one field\n *\n * @param data timemap format\n * @param groupBy\n * @param dedupBy\n * @param orderBy\n *\n * @return processed data\n */\nexport function processTimeMap(data, {groupBy, dedupBy, orderBy} = {}) {\n  if (!data) {\n    return data;\n  }\n\n  const fields = new Fields(data);\n\n  const res = data\n    .slice(1)\n    .reduce((result, row) => {\n      const oneGroup = result[fields.getValueByName(row, groupBy)] || {};\n\n      // don't add if we already have it\n      if (!oneGroup[fields.getValueByName(row, dedupBy)]) {\n        oneGroup[fields.getValueByName(row, dedupBy)] = row;\n      }\n\n      result[fields.getValueByName(row, groupBy)] = oneGroup;\n      return result;\n    }, {});\n    \n  // if someday we would get bad performance here\n  // we could make insertion with sorthing above\n  return _(res)\n    .mapValues(value => Object.values(value))\n    .mapValues(value => _.sortBy(value, fields.getIndexByName(orderBy)))\n    .value();\n}\n","export function renderContainer() {\n  let content = document.createElement('div');\n  content.setAttribute('class', 'rt-content');\n  let divBtn = document.createElement('div');\n  divBtn.setAttribute('class', 'div-btn');\n\n  let sequence = document.createElement('p');\n  sequence.setAttribute('class', 'sequence');\n  let chart = document.createElement('div');\n  chart.setAttribute('id', 'chart');\n  content.appendChild(divBtn);\n  content.appendChild(sequence);\n  content.appendChild(chart);\n  content.style.display = 'block';\n  return content;\n}\n","import * as d3 from 'd3';\n\nconst arc = d3.arc()\n  .startAngle(d => d.x0)\n  .endAngle(d => d.x1)\n  .innerRadius(d => Math.sqrt(d.y0))\n  .outerRadius(d => Math.sqrt(d.y1));\n\nconst colors = d3.scaleOrdinal(d3.schemePaired);\n\n/**\n * Render d3.hierarchy from passed hierarchical data\n *\n * @param element\n * @param vis\n * @param radius\n * @param baseURL\n * @param currentYear\n * @param data\n */\nexport function createVisualization(element, vis, radius, baseURL, currentYear, data) {\n  let partition = d3.partition()\n    .size([2 * Math.PI, radius * radius]);\n\n  //append 'root' we will exclude it on rendering\n  let root = d3.hierarchy({children: [data]})\n    .sum(d => !d.children)\n    .sort((a, b) => b.value - a.value);\n\n  let nodes = partition(root)\n    .descendants();\n\n  vis.selectAll('path')\n    .data(nodes)\n    .enter()\n    .append('a')\n    .attr('xlink:href', currentUrl)\n    .on('touchstart', touchStart)\n    .append('svg:path')\n    .attr('display', d => d.depth ? null : 'none')\n    .attr('d', arc)\n    .attr('fill-rule', 'evenodd')\n    .style('fill', d => colors((d.children ? d : d.parent).data.name))\n    .style('opacity', 1)\n    .style('cursor', 'pointer')\n    .on('mouseover', mouseover);\n\n  d3.select('#d3_container')\n    .on('mouseleave', mouseleave);\n\n  /** on mobile devices, touching the RadialTree prevents the ``click``\n   *  event and shows the URL like on ``mouseover`` event. Users can click\n   *  on the URL to visit the target page */\n  function touchStart(d) {\n    d3.event.preventDefault();\n    d3.event.stopPropagation();\n    mouseover(d);\n    return false;\n  }\n\n  function currentUrl(d) {\n    const anc = d.ancestors().reverse();\n    let url = '';\n    for (let i = 1; i < anc.length; i++) {\n      if (anc[i].data.name === 'end') {\n        break;\n      }\n      url = url + '/' + anc[i].data.name;\n    }\n    return `${baseURL}/web/${currentYear}0630${url}`;\n  }\n\n  function mouseover(d) {\n    let sequenceArray = d.ancestors().reverse();\n    sequenceArray.shift();\n    let url = currentUrl(d);\n    updateBreadcrumbs(sequenceArray, url);\n    d3.selectAll('path').style('opacity', 0.3);\n\n    vis\n      .selectAll('path')\n      .filter(node => sequenceArray.indexOf(node) >= 0)\n      .style('opacity', 1);\n  }\n\n  function mouseleave() {\n    element.querySelector('.sequence').innerHTML = '';\n\n    d3.selectAll('path')\n      .on('mouseover', null);\n\n    d3.selectAll('path')\n      .transition()\n      .style('opacity', 1)\n      .on('end', function () {\n        d3.select(this).on('mouseover', mouseover);\n      });\n  }\n\n  function updateBreadcrumbs(nodeArray, url) {\n    let text = '';\n    let symb = document.createElement('span');\n    symb.setAttribute('class', 'symb');\n    symb.innerHTML = '/';\n    for (let i = 0; i < nodeArray.length; i++) {\n      if (i === 0) {\n        text = ' ' + nodeArray[i].data.name;\n      } else {\n        text = text + symb.innerHTML + nodeArray[i].data.name;\n      }\n    }\n    text = decodeURIComponent(text);\n    element.querySelector('.sequence').innerHTML = `<a href=\"${url}\">${text}</a>`;\n  }\n}\n","export function renderYearButton(year) {\n  let btn = document.createElement('button');\n  btn.setAttribute('class', 'year-btn');\n  btn.setAttribute('id', year);\n  btn.innerHTML = year;\n  return btn;\n}\n\nexport function getYearByBtn(btn) {\n  return btn.id;\n}\n\nexport function getButtonByYear(container, year) {\n  return container.ownerDocument.getElementById(year);\n}\n","import {renderYearButton, getYearByBtn} from './year-button';\n\nexport function renderYearButtons(element, allYears, onYearSelect) {\n  let divBtn = element.querySelector('.div-btn');\n  divBtn.onclick = (evt) => onYearSelect(getYearByBtn(evt.target));\n\n  if (!element.querySelector('.year-btn')) {\n    allYears.forEach(year =>\n      divBtn.appendChild(renderYearButton(year))\n    );\n  }\n}\n","import * as d3 from 'd3';\nimport {buildHierarchy, extractYearsFromGroupedTimeMap, Fields, processTimeMap} from './processing';\nimport {createVisualization, getButtonByYear, renderContainer, renderYearButtons} from './rendering';\n\n/**\n *\n * Radial Tree Library\n *\n * @param {DOMElement} element\n * @param {Array} cdx_data: decoded CDX Query data retrieved by:\n ``/web/timemap/json?url=example.com/&fl=timestamp:4,urlkey&matchType=prefix\n &filter=statuscode:200&filter=mimetype:text/html&collapse=urlkey\n &collapse=timestamp:4&limit=100000``.\n * @param {Object} [options]\n * Option baseURL defines the target Wayback Machine server.\n *\n */\nexport function RadialTree(element, cdx_data, options = {}) {\n  let baseURL = options.baseURL || 'https://web.archive.org';\n\n  // render\n\n  const container = renderContainer();\n  element.appendChild(container);\n\n  const fields = new Fields(cdx_data);\n  const urlsByYear = processTimeMap(cdx_data, {\n    groupBy: 'timestamp:4',\n    dedupBy: 'urlkey',\n    orderBy: 'urlkey',\n  });\n  const years = extractYearsFromGroupedTimeMap(urlsByYear);\n\n  renderYearButtons(element, years, selectYear);\n\n  // highlight the 2nd last year if available, else hightlight the last.\n  // necessary because the last year may not have much data.\n  // const lastButOneYear = allYears[allYears.length - 2] || allYears[0];\n  const selectedBtn = years[years.length - 2] || years[0];\n  selectYear(selectedBtn);\n\n  function selectYear(year) {\n    // hide active button\n    if (element.querySelector('.active-btn')) {\n      element.querySelector('.active-btn').classList.remove('active-btn');\n    }\n\n    // show active button\n    const btn = getButtonByYear(element, year);\n    if (btn) {\n      btn.classList.add('active-btn');\n    }\n\n    renderChart(element, year);\n  }\n\n  function renderChart(element, currentYear) {\n    element.querySelector('.sequence').innerHTML = '';\n    element.querySelector('#chart').innerHTML = '';\n\n    const width = element.querySelector('#chart').offsetWidth;\n    const height = width;\n    const radius = Math.min(width, height) / 2;\n\n    let vis = d3.select('#chart')\n      .append('svg:svg')\n      .attr('width', width)\n      .attr('height', height)\n      .append('svg:g')\n      .attr('id', 'd3_container')\n      .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');\n\n    vis.append('svg:circle')\n      .attr('r', radius)\n      .style('opacity', 0);\n\n    const urls = urlsByYear[currentYear];\n    const hierarchy = buildHierarchy(fields, urls, {\n      targetField: 'urlkey',\n    });\n\n    createVisualization(element, vis, radius, baseURL, currentYear, hierarchy);\n  }\n}\n"],"names":["buildHierarchy","fields","data","targetField","reduce","res","row","surt","getValueByName","split","host","path","name","slice","length","reverse","join","buildHierarchInDepth","parent","rest","nextParent","children","filter","c","push","Fields","getIndexByName","_","memoize","this","indexOf","extractYearsFromGroupedTimeMap","Object","keys","sort","processTimeMap","groupBy","dedupBy","orderBy","result","oneGroup","mapValues","values","value","sortBy","renderContainer","content","document","createElement","setAttribute","divBtn","sequence","chart","appendChild","style","display","arc","d3","startAngle","d","x0","endAngle","x1","innerRadius","Math","sqrt","y0","outerRadius","y1","colors","createVisualization","element","vis","radius","baseURL","currentYear","nodes","size","PI","partition","sum","a","b","descendants","currentUrl","anc","ancestors","url","i","mouseover","sequenceArray","shift","nodeArray","text","symb","innerHTML","decodeURIComponent","querySelector","selectAll","node","enter","append","attr","on","preventDefault","stopPropagation","depth","transition","getButtonByYear","container","year","ownerDocument","getElementById","renderYearButtons","allYears","onYearSelect","onclick","evt","target","id","forEach","btn","renderYearButton","cdx_data","options","urlsByYear","years","selectYear","selectedBtn","classList","remove","add","renderChart","width","offsetWidth","height","min","urls","hierarchy"],"mappings":"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"}